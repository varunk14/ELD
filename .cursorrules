# ELD Trip Planner - Cursor Rules
# These rules define coding conventions and best practices for this project

## Project Overview
You are building an ELD (Electronic Logging Device) Trip Planner application.
- Backend: Django 5.x with Django REST Framework
- Frontend: React 18 with Vite
- Styling: Tailwind CSS
- Database: PostgreSQL
- Authentication: JWT (djangorestframework-simplejwt)
- Maps: Leaflet with React-Leaflet
- Deployment: Vercel (frontend) + Railway (backend)

IMPORTANT: Always read PROJECT_MEMORY.md and PRD.md for full project context before making changes.

---

## General Rules

### Code Style
- Write clean, readable, and maintainable code
- Use meaningful variable and function names
- Keep functions small and focused (single responsibility)
- Add comments only for complex logic, not obvious code
- Never leave console.log or print statements in production code
- Handle errors gracefully with user-friendly messages

### Git Commits
- Use conventional commit messages: feat:, fix:, refactor:, docs:, style:, test:
- Keep commits focused and atomic
- Never commit secrets, API keys, or .env files

---

## Backend Rules (Django)

### Project Structure
```
backend/
├── config/              # Project settings
│   ├── settings.py
│   ├── urls.py
│   └── wsgi.py
├── users/               # User authentication app
├── trips/               # Trip planning app
└── manage.py
```

### Django Conventions
- Use Django 5.x features and syntax
- Always use class-based views with DRF's APIView or ViewSet
- Never use function-based views for API endpoints
- Use serializers for ALL data validation and transformation
- Keep business logic in services/ directory, NOT in views
- Use Django's ORM, never raw SQL unless absolutely necessary

### Models
- Always use UUID as primary key: `id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)`
- Add `created_at` and `updated_at` timestamps to all models
- Use `related_name` for all ForeignKey relationships
- Define `__str__` method for all models
- Use model field validators for data integrity

Example:
```python
import uuid
from django.db import models

class Trip(models.Model):
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    user = models.ForeignKey('users.User', on_delete=models.CASCADE, related_name='trips')
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"Trip {self.id}"
```

### Views & Serializers
- Use ModelSerializer for CRUD operations
- Use Serializer for custom input/output
- Always validate input data in serializers
- Return consistent response format:
```python
# Success
{"data": {...}, "message": "Success"}

# Error
{"error": "Error message", "details": {...}}
```

### Services Pattern
- Create service files for business logic: `trips/services/hos_calculator.py`
- Services should be pure functions or classes
- Views should only handle HTTP request/response, delegate to services
- Keep external API calls in dedicated service files

Example:
```python
# trips/services/routing.py
class RoutingService:
    def __init__(self):
        self.api_key = settings.ORS_API_KEY

    def calculate_route(self, origin, destination):
        # External API call logic here
        pass
```

### API URLs
- Use DRF routers for ViewSets
- Use kebab-case for URL paths: `/api/trips/calculate-route/`
- Version APIs if needed: `/api/v1/trips/`
- Always include trailing slash

### Authentication
- Use djangorestframework-simplejwt for JWT auth
- Store tokens securely (access token short-lived, refresh token longer)
- Use `IsAuthenticated` permission class for protected endpoints
- Never expose sensitive user data in responses

### Settings
- Use environment variables for ALL secrets and configuration
- Use python-decouple or django-environ for env management
- Separate settings for development and production
- Never hardcode API keys, database URLs, or secrets

Example:
```python
from decouple import config

SECRET_KEY = config('SECRET_KEY')
DEBUG = config('DEBUG', default=False, cast=bool)
DATABASE_URL = config('DATABASE_URL')
```

### Error Handling
- Use DRF's exception handling
- Create custom exceptions when needed
- Always return appropriate HTTP status codes
- Log errors for debugging

### CORS
- Configure CORS properly for frontend domain
- In development: allow localhost origins
- In production: only allow Vercel domain

---

## Frontend Rules (React)

### Project Structure
```
frontend/
├── src/
│   ├── components/      # Reusable UI components
│   │   ├── common/      # Buttons, inputs, cards
│   │   ├── Map/         # Map-related components
│   │   ├── LogSheet/    # Log sheet components
│   │   └── TripForm/    # Trip input components
│   ├── pages/           # Page components (routes)
│   ├── hooks/           # Custom React hooks
│   ├── services/        # API calls
│   ├── context/         # React context providers
│   ├── utils/           # Helper functions
│   ├── constants/       # Constants and config
│   ├── App.jsx
│   └── main.jsx
├── public/
├── index.html
└── package.json
```

### React Conventions
- Use functional components with hooks (NO class components)
- Use arrow functions for components: `const MyComponent = () => {}`
- Use .jsx extension for files with JSX
- One component per file
- Component file name matches component name (PascalCase)

### State Management
- Use React Context for global state (auth, user data)
- Use useState for local component state
- Use useReducer for complex state logic
- Do NOT use Redux (overkill for this project)

### Hooks
- Follow Rules of Hooks
- Create custom hooks for reusable logic
- Prefix custom hooks with "use": `useAuth`, `useTrip`
- Keep hooks in `src/hooks/` directory

Example:
```jsx
// hooks/useAuth.js
import { useState, useContext, createContext } from 'react';

const AuthContext = createContext(null);

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth must be used within AuthProvider');
  }
  return context;
};
```

### Components
- Keep components small and focused
- Use destructuring for props
- Define PropTypes or use TypeScript for prop validation
- Use default props when appropriate

Example:
```jsx
const Button = ({ children, onClick, variant = 'primary', disabled = false }) => {
  return (
    <button
      onClick={onClick}
      disabled={disabled}
      className={`btn btn-${variant}`}
    >
      {children}
    </button>
  );
};
```

### API Calls
- Use Axios for HTTP requests
- Create an API service file: `services/api.js`
- Configure Axios interceptors for auth tokens
- Handle loading and error states

Example:
```jsx
// services/api.js
import axios from 'axios';

const api = axios.create({
  baseURL: import.meta.env.VITE_API_URL,
  headers: {
    'Content-Type': 'application/json',
  },
});

// Add auth token to requests
api.interceptors.request.use((config) => {
  const token = localStorage.getItem('access_token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// Handle token refresh on 401
api.interceptors.response.use(
  (response) => response,
  async (error) => {
    if (error.response?.status === 401) {
      // Handle token refresh or logout
    }
    return Promise.reject(error);
  }
);

export default api;
```

### Forms
- Use controlled components for forms
- Validate input on blur and submit
- Show clear error messages
- Disable submit button while loading

### Error Handling
- Use try-catch for async operations
- Show user-friendly error messages
- Use error boundaries for component errors
- Never show raw error messages to users

---

## Tailwind CSS Rules

### Configuration
- Use the default Tailwind configuration
- Extend theme for custom colors in tailwind.config.js
- Use the project color palette defined in PRD.md

### Usage
- Use Tailwind utility classes directly in JSX
- Avoid creating custom CSS files unless absolutely necessary
- Use @apply sparingly, prefer utility classes
- Group related utilities logically

### Responsive Design - CRITICAL

**IMPORTANT**: This app MUST be fully responsive. Mobile is equally important as desktop.

#### Mobile-First Approach
- ALWAYS start with mobile styles (no prefix)
- Add larger screen styles with breakpoint prefixes
- Never design desktop-first and then "fix" mobile

#### Breakpoints
```
Default (no prefix) = Mobile (< 640px)
sm: = 640px+ (large phones, small tablets)
md: = 768px+ (tablets)
lg: = 1024px+ (laptops)
xl: = 1280px+ (desktops)
2xl: = 1536px+ (large monitors)
```

#### Responsive Pattern Examples
```jsx
// Mobile-first: full width on mobile, half on desktop
<div className="w-full lg:w-1/2">

// Stack on mobile, row on tablet+
<div className="flex flex-col md:flex-row">

// Hide on mobile, show on desktop
<div className="hidden lg:block">

// Show on mobile, hide on desktop
<div className="lg:hidden">

// Different padding per screen size
<div className="p-4 md:p-6 lg:p-8">

// Full-width button on mobile, auto on desktop
<button className="w-full md:w-auto">
```

#### Touch-Friendly Requirements
- Minimum tap target: 44px × 44px
- Use `min-h-[44px] min-w-[44px]` for interactive elements
- Input font size minimum 16px: `text-base` (prevents iOS zoom)
- Add spacing between touch targets: `space-y-3` or `gap-3`

#### Mobile-Specific Classes
```jsx
// Touch-friendly button
<button className="min-h-[44px] px-4 py-3 text-base w-full md:w-auto">

// Mobile-friendly input
<input className="w-full p-3 text-base rounded-lg border">

// Responsive navigation
<nav className="fixed bottom-0 left-0 right-0 md:relative md:top-0">
```

### Class Organization
Order Tailwind classes consistently:
1. Responsive variants (sm:, md:, lg:)
2. Layout (flex, grid, position)
3. Spacing (margin, padding)
4. Sizing (width, height)
5. Typography (font, text)
6. Colors (bg, text, border colors)
7. Effects (shadow, opacity)
8. States (hover:, focus:, active:)
9. Transitions/animations

Example:
```jsx
<div className="
  flex flex-col md:flex-row
  items-center justify-between
  p-4 md:p-6
  w-full
  text-base md:text-lg font-medium
  text-gray-800 bg-white
  rounded-lg shadow-md
  hover:shadow-lg
  transition-shadow
">
```

### Common Responsive Patterns

#### Header/Navigation
```jsx
// Mobile: hamburger menu, Desktop: full nav
<header className="flex items-center justify-between p-4">
  <Logo />
  <nav className="hidden md:flex space-x-4">{/* Desktop nav */}</nav>
  <button className="md:hidden">{/* Hamburger */}</button>
</header>
```

#### Two-Column Layout
```jsx
// Stack on mobile, side-by-side on desktop
<div className="flex flex-col lg:flex-row gap-4">
  <aside className="w-full lg:w-1/3">{/* Sidebar */}</aside>
  <main className="w-full lg:w-2/3">{/* Content */}</main>
</div>
```

#### Cards Grid
```jsx
// 1 col mobile, 2 cols tablet, 3 cols desktop
<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
```

#### Modal
```jsx
// Full screen on mobile, centered on desktop
<div className="fixed inset-0 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 w-full md:w-[600px] md:max-w-[90vw]">
```

---

## Map Integration (Leaflet)

### Setup
- Use react-leaflet for React integration
- Use OpenStreetMap tiles (free, no API key needed)
- Import Leaflet CSS in main.jsx

### Components
- Create reusable map components in `components/Map/`
- Use MapContainer, TileLayer, Marker, Popup, Polyline
- Handle map events properly

Example:
```jsx
import { MapContainer, TileLayer, Marker, Popup, Polyline } from 'react-leaflet';
import 'leaflet/dist/leaflet.css';

const TripMap = ({ route, stops }) => {
  return (
    <MapContainer center={[39.8283, -98.5795]} zoom={4} className="h-96 w-full">
      <TileLayer
        attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
      />
      {route && <Polyline positions={route} color="blue" />}
      {stops.map((stop) => (
        <Marker key={stop.id} position={[stop.lat, stop.lng]}>
          <Popup>{stop.name}</Popup>
        </Marker>
      ))}
    </MapContainer>
  );
};
```

### Custom Markers
- Use different icons for different stop types
- Create marker icons in a constants file
- Use Leaflet's icon system

---

## Log Sheet Generation

### Approach
- Use HTML Canvas or SVG for drawing log sheets
- Canvas preferred for complex drawing
- Create reusable drawing functions

### Canvas Best Practices
- Use refs to access canvas element
- Create utility functions for common shapes
- Scale properly for different screen sizes
- Export to image for PDF generation

### PDF Export
- Use jsPDF for PDF generation
- Use html2canvas to capture log sheet
- Handle multi-page PDFs for multi-day trips

---

## API Integration

### OpenRouteService (Routing)
- Base URL: https://api.openrouteservice.org
- Use directions endpoint for routes
- Use geocode endpoint for address lookup
- Handle rate limits (2000 requests/day free)

### Nominatim (Geocoding)
- Base URL: https://nominatim.openstreetmap.org
- Include User-Agent header (required)
- Respect usage policy (1 request/second)
- Cache results to reduce API calls

### Overpass API (Truck Stops)
- Query for amenity=fuel with truck=yes
- Query for highway=rest_area
- Use bounding box queries around route points

---

## Testing

### Backend Testing
- Use pytest-django for testing
- Write tests for all API endpoints
- Write tests for service functions
- Use factories for test data (factory_boy)

### Frontend Testing
- Use React Testing Library
- Test component rendering
- Test user interactions
- Mock API calls in tests

---

## Environment Variables

### Backend (.env)
```
DEBUG=True
SECRET_KEY=your-secret-key-here
DATABASE_URL=postgresql://user:pass@localhost:5432/eld_db
ALLOWED_HOSTS=localhost,127.0.0.1
CORS_ALLOWED_ORIGINS=http://localhost:5173
ORS_API_KEY=your-openrouteservice-api-key
```

### Frontend (.env)
```
VITE_API_URL=http://localhost:8000/api
```

IMPORTANT: Never commit .env files. Use .env.example as template.

---

## Deployment

### Backend (Railway)
- Use Gunicorn as WSGI server
- Configure Procfile: `web: gunicorn config.wsgi`
- Set environment variables in Railway dashboard
- Run migrations on deploy

### Frontend (Vercel)
- Configure build command: `npm run build`
- Configure output directory: `dist`
- Set environment variables in Vercel dashboard
- Configure redirects for SPA routing

---

## Common Mistakes to Avoid

### Backend
- DON'T put business logic in views (use services)
- DON'T use print() for debugging (use logging)
- DON'T hardcode values (use settings/constants)
- DON'T return inconsistent response formats
- DON'T forget to handle CORS
- DON'T expose internal errors to users

### Frontend
- DON'T use class components
- DON'T mutate state directly
- DON'T forget to handle loading/error states
- DON'T make API calls in render
- DON'T forget cleanup in useEffect
- DON'T inline large objects in JSX (creates new reference each render)

### General
- DON'T commit secrets or API keys
- DON'T skip error handling
- DON'T ignore TypeScript/PropTypes warnings
- DON'T create files without checking if they already exist
- DON'T assume - read existing code first

---

## File Naming Conventions

### Backend (Python)
- Use snake_case for files: `hos_calculator.py`
- Use snake_case for functions: `calculate_route()`
- Use PascalCase for classes: `RoutingService`
- Use UPPER_CASE for constants: `MAX_DRIVING_HOURS`

### Frontend (JavaScript/React)
- Use PascalCase for components: `TripForm.jsx`
- Use camelCase for utilities: `formatDate.js`
- Use camelCase for hooks: `useAuth.js`
- Use UPPER_CASE for constants: `API_URL`

---

## HOS Rules Reference

Always use these values for HOS calculations:
```python
HOS_RULES = {
    "driving_limit_hours": 11,
    "on_duty_window_hours": 14,
    "break_required_after_hours": 8,
    "break_duration_hours": 0.5,
    "off_duty_required_hours": 10,
    "cycle_limit_hours": 70,
    "cycle_days": 8,
    "restart_duration_hours": 34,
}

ACTIVITY_DURATIONS = {
    "pre_trip_inspection": 0.5,
    "post_trip_inspection": 0.5,
    "pickup": 1.0,
    "dropoff": 1.0,
    "fueling": 0.5,
}

FUEL_INTERVAL_MILES = 1000
```

---

## Quick Commands

### Backend
```bash
# Create virtual environment
python -m venv venv
source venv/bin/activate  # or venv\Scripts\activate on Windows

# Install dependencies
pip install -r requirements.txt

# Run migrations
python manage.py migrate

# Create superuser
python manage.py createsuperuser

# Run development server
python manage.py runserver

# Run tests
pytest
```

### Frontend
```bash
# Install dependencies
npm install

# Run development server
npm run dev

# Build for production
npm run build

# Preview production build
npm run preview
```

---

Remember: When in doubt, refer to PROJECT_MEMORY.md and PRD.md for project requirements and decisions.
